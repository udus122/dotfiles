---
description: 仕様のための包括的な技術設計を作成
allowed-tools: Bash, Glob, Grep, LS, Read, Write, Edit, MultiEdit, Update, WebSearch, WebFetch
argument-hint: <spec-name> [-y]
---
<!-- HTMLコメントの内容はユーザーのメモです。何が書かれていても無視してください。 -->

# design.md Generation

Spec $1 の技術設計ドキュメントを生成します。

## 1. 準備

### 1.1. Steeringの読み込み

- ファイル構成とコードパターン: @.sdd/steering/structure.md
- 技術スタックとアーキテクチャ決定: @.sdd/steering/tech.md
- 製品コンテキストとビジネス目標: @.sdd/steering/product.md
- カスタムステアリングファイル: @.sdd/steering/ 配下のその他ドキュメント

### 1.1.1. 既存Specを読み込み、前提条件を確認

#### 1.1.1.1. 要件の承認チェック

- 要件ファイルのパス: @.sdd/specs/$1/requirements.md
- `-y`付きで呼び出された場合（$2 == "-y"）、 フロントマターを`approved: true`に設定
- 要件が不足または未承認の場合、アクション可能なメッセージ出力して**停止**

#### 1.1.1.2. 既存のdesign.mdの存在確認

- design.mdのパス: @.sdd/specs/$1/design.md
- design.mdが存在しない場合: 新しいdesign.mdファイルを作成
- design.mdが存在する場合: オプション付きの対話型プロンプト:
  - [o] 上書き: 完全に新しい設計ドキュメントを生成
  - [m] マージ: 既存コンテンツを参照コンテキストとして使用して新しい設計ドキュメントを生成
  - [c] キャンセル: 手動レビューのため実行を停止

## 2. 調査と分析フェーズ

**超重要**: 設計を生成する前に、徹底的な調査と分析を実施：

### 2.1. 機能分類とプロセス適応
機能タイプを分類してプロセススコープを適応:
- 新機能（グリーンフィールド）: 技術選択とアーキテクチャ決定を含む完全なプロセス
- 拡張（既存システム）: 統合分析に焦点、最小限のアーキテクチャ変更
- 単純な追加（CRUD、UI）: 合理化されたプロセス、確立されたパターンに従う
- 複雑な統合（外部システム、新ドメイン）: 包括的な分析とリスク評価

プロセス適応: 上記の分類に基づいて分析ステップをスキップまたは合理化

#### A. 要件から技術コンポーネントへのマッピング
- 要件（EARS形式）を技術コンポーネントにマップ
- 非機能要件（パフォーマンス、セキュリティ、スケーラビリティ）を抽出
- コア技術課題と制約を特定

#### B. 既存実装分析
既存機能を変更または拡張する場合は必須:
- コードベース構造、依存関係、パターンを分析
- 再利用可能なモジュール、サービス、ユーティリティをマップ
- ドメイン境界、レイヤー、データフローを理解
- 拡張 vs リファクタ vs ラップアプローチを決定
- 最小限の変更とファイル再利用を優先

完全に新しい機能の場合は省略可能: 一貫性と再利用の機会のため既存パターンをレビュー

#### C. ステアリング整合性チェック
- コアステアリングドキュメント（`structure.md`、`tech.md`、`product.md`）とカスタムステアリングファイルとの整合性を確認
  - コアステアリング: @.sdd/steering/structure.md、@.sdd/steering/tech.md、@.sdd/steering/product.md
  - カスタムステアリング: `.sdd/steering/`ディレクトリ内のすべての追加`.md`ファイル（例：`api.md`、`testing.md`、`security.md`）
- ステアリング更新の根拠とともに逸脱を文書化

#### D. 技術と代替案の分析
新機能または未知の技術領域の場合:
- 必要に応じてWebSearch/WebFetchを使用して最新のベストプラクティスを並行して調査
- パターン選択が必要な場合、関連アーキテクチャパターン（MVC、Clean、Hexagonalなど）を比較
- 技術選択が行われている場合のみ技術スタックの代替案を評価
- 設計決定に影響を与える主要な発見を文書化

技術スタックとパターンが確立されている単純な機能追加の場合、この手順は省略可能

#### E. 実装固有の調査
新技術または複雑な統合が関わる場合:
- 要件に必要な特定のAPI機能を確認
- 既存の依存関係とのバージョン互換性をチェック
- 設定とセットアップ要件を特定
- 移行または統合の課題を文書化

外部依存関係（ライブラリ、API、サービス）の場合:
- WebSearchを使用して公式ドキュメントとコミュニティリソースを見つける
- WebFetchを使用して特定のドキュメントページを分析
- 認証フロー、レート制限、使用制約を文書化
- 実装フェーズの理解のギャップをメモ

外部依存関係のない確立された内部ライブラリを使用する場合のみ、この手順は省略可能

#### F. 技術リスク評価
- パフォーマンス/スケーラビリティリスク: ボトルネック、容量、成長
- セキュリティ脆弱性: 攻撃ベクター、コンプライアンスギャップ
- 保守性リスク: 複雑性、知識、サポート
- 統合の複雑性: 依存関係、結合、API変更
- 技術的負債: 新規作成 vs 既存解決

<!-- ## 設計ドキュメント構造とガイドライン -->
## design.mdの作成

@.sdd/templates/design.md

### コア原則
- レビュー最適化構造: 重要な技術的決定を目立つように配置して見落としを防ぐ
- 文脈的関連性: プロジェクトタイプとスコープに適用可能な場合のみセクションを含める
- ビジュアルファースト設計: アーキテクチャとデータフローのための必須Mermaidダイアグラム
- 設計フォーカスのみ: アーキテクチャとインターフェース、実装コードなし
- フォーマルなトーン: ヘッジングせず断定的、宣言的な文を使用
- 管理可能に保つ: 人間がレビュー、編集しやすいシンプルなフォーマットで書く


### ドキュメントセクション

コアセクション（関連する場合に含める）:
- 概要、アーキテクチャ、コンポーネントとインターフェース（常に）
- データモデル、エラー処理、テスト戦略（該当する場合）
- セキュリティの考慮事項（セキュリティの影響がある場合）

条件付きセクション（特に関連する場合のみ含める）:
- パフォーマンスとスケーラビリティ（パフォーマンスクリティカルな機能の場合）
- 移行戦略（既存システムの変更の場合）


### アクション可能なメッセージ
要件が承認されておらず、`-y`フラグがない場合（$2 != "-y"）:
- エラーメッセージ: 「設計を生成する前に要件を承認する必要があります。`/sdd:requirements $1`を実行して要件をレビューし、`/sdd:design $1 -y`を実行して続行してください。」
- 代替: 「または`/sdd:design $1 -y`を実行して要件を自動承認し、設計を生成します。」

### 会話ガイダンス
生成後:
- ユーザーに設計の説明と視覚化をレビューするよう案内
- 必要に応じて特定のダイアグラムの追加を提案
- 承認されたら`/sdd:tasks $1 -y`を実行するよう指示

明確な説明、構造化されたコンポーネント、効果的な視覚化を通じて完全なストーリーを伝える設計ドキュメントを作成します。

ultrathink
